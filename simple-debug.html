<!DOCTYPE html>
<html>
<head>
    <title>Egyszer≈± Debug</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .log { background: #f0f0f0; padding: 10px; margin: 5px 0; border-radius: 5px; font-family: monospace; }
        .error { background: #ffebee; border-left: 4px solid #f44336; }
        .success { background: #e8f5e8; border-left: 4px solid #4caf50; }
        .info { background: #e3f2fd; border-left: 4px solid #2196f3; }
        button { padding: 15px 25px; font-size: 16px; margin: 10px; border: none; border-radius: 5px; cursor: pointer; }
        .test-btn { background: #2196f3; color: white; }
        .delete-btn { background: #f44336; color: white; }
        .count { font-size: 24px; font-weight: bold; color: #f44336; margin: 20px 0; }
    </style>
</head>
<body>
    <h1>üîß Egyszer≈± Debug Tool</h1>
    
    <div class="count" id="status">Bet√∂lt√©s...</div>
    
    <button onclick="testBasics()" class="test-btn">1Ô∏è‚É£ Alapok tesztel√©se</button>
    <button onclick="testSupabase()" class="test-btn">2Ô∏è‚É£ Supabase teszt</button>
    <button onclick="countSets()" class="test-btn">3Ô∏è‚É£ Szettek sz√°ml√°l√°sa</button>
    <button onclick="deleteSets()" class="delete-btn">4Ô∏è‚É£ Szettek t√∂rl√©se</button>
    
    <div id="logs"></div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        let logIndex = 0;
        
        function log(message, type = 'info') {
            logIndex++;
            const timestamp = new Date().toLocaleTimeString();
            const logs = document.getElementById('logs');
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : 'info';
            logs.innerHTML += `<div class="log ${className}">[${logIndex}] ${timestamp} - ${message}</div>`;
            logs.scrollTop = logs.scrollHeight;
            console.log(`[${logIndex}] ${message}`);
        }
        
        function updateStatus(message) {
            document.getElementById('status').innerHTML = message;
        }
        
        async function testBasics() {
            log('üîß Alapok tesztel√©se kezdete...', 'info');
            
            try {
                // Test 1: JavaScript m≈±k√∂dik
                log('‚úÖ JavaScript m≈±k√∂dik', 'success');
                
                // Test 2: Console API
                console.log('Console API teszt');
                log('‚úÖ Console API m≈±k√∂dik', 'success');
                
                // Test 3: Supabase CDN bet√∂ltve-e
                if (typeof window.supabase === 'undefined') {
                    log('‚ùå Supabase CDN nem t√∂lt≈ëd√∂tt be!', 'error');
                    return;
                } else {
                    log('‚úÖ Supabase CDN bet√∂ltve', 'success');
                }
                
                // Test 4: createClient el√©rhet≈ë-e
                if (typeof window.supabase.createClient === 'function') {
                    log('‚úÖ createClient f√ºggv√©ny el√©rhet≈ë', 'success');
                } else {
                    log('‚ùå createClient f√ºggv√©ny nem el√©rhet≈ë!', 'error');
                    return;
                }
                
                updateStatus('‚úÖ Alapok rendben - folytathat√≥ a k√∂vetkez≈ë l√©p√©ssel');
                
            } catch (error) {
                log(`‚ùå Alapok teszt hiba: ${error.message}`, 'error');
                updateStatus('‚ùå Alapok teszt hiba');
            }
        }
        
        async function testSupabase() {
            log('üîó Supabase kapcsolat tesztel√©se...', 'info');
            
            try {
                // Supabase client l√©trehoz√°sa
                const SUPABASE_URL = 'https://ycxqxdhaxehspypqbnpi.supabase.co';
                const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InljeHF4ZGhheGVoc3B5cHFibnBpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMyMDMwMzEsImV4cCI6MjA2ODc3OTAzMX0.7RGVld6WOhNgeTA6xQc_U_eDXfMGzIshUlKV6j2Ru6g';
                
                log(`üîë URL: ${SUPABASE_URL}`, 'info');
                log(`üîë Key: ${SUPABASE_ANON_KEY.substring(0, 20)}...`, 'info');
                
                const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                log('‚úÖ Supabase client l√©trehozva', 'success');
                
                // Egyszer≈± teszt query
                log('üì° Teszt query k√ºld√©se...', 'info');
                const { data, error, count } = await supabase
                    .from('flashcard_sets')
                    .select('id', { count: 'exact', head: true });
                
                if (error) {
                    log(`‚ùå Supabase query hiba: ${error.message}`, 'error');
                    log(`üîç Error details: ${JSON.stringify(error)}`, 'error');
                    updateStatus('‚ùå Supabase kapcsolat hiba');
                    return;
                } else {
                    log(`‚úÖ Supabase query sikeres! Szettek sz√°ma: ${count}`, 'success');
                    updateStatus(`üîó Supabase kapcsolat OK - ${count} szett tal√°lhat√≥`);
                }
                
            } catch (error) {
                log(`‚ùå Supabase teszt hiba: ${error.message}`, 'error');
                log(`üîç Stack trace: ${error.stack}`, 'error');
                updateStatus('‚ùå Supabase teszt hiba');
            }
        }
        
        async function countSets() {
            log('üìä Szettek r√©szletes sz√°ml√°l√°sa...', 'info');
            
            try {
                const SUPABASE_URL = 'https://ycxqxdhaxehspypqbnpi.supabase.co';
                const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InljeHF4ZGhheGVoc3B5cHFibnBpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMyMDMwMzEsImV4cCI6MjA2ODc3OTAzMX0.7RGVld6WOhNgeTA6xQc_U_eDXfMGzIshUlKV6j2Ru6g';
                const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                
                const { data: sets, error } = await supabase
                    .from('flashcard_sets')
                    .select('id, title, created_at, creator_id')
                    .order('created_at', { ascending: false });
                
                if (error) {
                    log(`‚ùå Szettek lek√©rdez√©si hiba: ${error.message}`, 'error');
                    return;
                }
                
                log(`üìä √ñSSZES SZETT: ${sets.length} db`, 'info');
                
                const cnnSets = sets.filter(set => set.title && set.title.toLowerCase().includes('cnn'));
                const otherSets = sets.filter(set => !set.title || !set.title.toLowerCase().includes('cnn'));
                
                log(`üéØ CNN szettek: ${cnnSets.length} db`, cnnSets.length > 0 ? 'success' : 'info');
                log(`üóëÔ∏è Egy√©b szettek: ${otherSets.length} db`, otherSets.length > 0 ? 'error' : 'success');
                
                // List all sets
                sets.forEach((set, index) => {
                    const isCNN = set.title && set.title.toLowerCase().includes('cnn');
                    const type = isCNN ? 'success' : 'error';
                    log(`${index + 1}. "${set.title}" (${set.id}) ${isCNN ? 'üéØ CNN' : 'üóëÔ∏è T√ñRLEND≈ê'}`, type);
                });
                
                updateStatus(`üìä ${sets.length} szett | üéØ ${cnnSets.length} CNN | üóëÔ∏è ${otherSets.length} t√∂rlend≈ë`);
                
            } catch (error) {
                log(`‚ùå Sz√°ml√°l√°si hiba: ${error.message}`, 'error');
                updateStatus('‚ùå Sz√°ml√°l√°si hiba');
            }
        }
        
        async function deleteSets() {
            log('üóëÔ∏è Szettek t√∂rl√©se kezdete...', 'error');
            
            if (!confirm('üö® FIGYELEM! Minden nem-CNN szett t√∂rl√©sre ker√ºl!\n\nBiztos folytatod?')) {
                log('‚ùå T√∂rl√©s megszak√≠tva a user √°ltal', 'info');
                return;
            }
            
            try {
                const SUPABASE_URL = 'https://ycxqxdhaxehspypqbnpi.supabase.co';
                const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InljeHF4ZGhheGVoc3B5cHFibnBpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMyMDMwMzEsImV4cCI6MjA2ODc3OTAzMX0.7RGVld6WOhNgeTA6xQc_U_eDXfMGzIshUlKV6j2Ru6g';
                const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                
                // Get sets to delete
                const { data: allSets, error: fetchError } = await supabase
                    .from('flashcard_sets')
                    .select('*');
                
                if (fetchError) {
                    log(`‚ùå Szettek lek√©rdez√©si hiba: ${fetchError.message}`, 'error');
                    return;
                }
                
                const toDelete = allSets.filter(set => !set.title || !set.title.toLowerCase().includes('cnn'));
                log(`üéØ T√∂rlend≈ë szettek: ${toDelete.length} db`, 'info');
                
                for (let i = 0; i < toDelete.length; i++) {
                    const set = toDelete[i];
                    log(`üóëÔ∏è [${i+1}/${toDelete.length}] T√∂rl√©s: "${set.title}" (${set.id})`, 'error');
                    
                    // Just try to delete the set directly first
                    const { data: deletedSet, error: deleteError } = await supabase
                        .from('flashcard_sets')
                        .delete()
                        .eq('id', set.id)
                        .select();
                    
                    if (deleteError) {
                        log(`   ‚ùå Szett t√∂rl√©si hiba: ${deleteError.message}`, 'error');
                        log(`   üîç Error details: ${JSON.stringify(deleteError)}`, 'error');
                        
                        // Try to delete connections first, then retry
                        log(`   üîß Kapcsolatok t√∂rl√©se...`, 'info');
                        
                        await supabase.from('flashcard_set_cards').delete().eq('set_id', set.id);
                        await supabase.from('flashcard_set_categories').delete().eq('set_id', set.id);
                        
                        // Retry set deletion
                        const { data: retryDeleted, error: retryError } = await supabase
                            .from('flashcard_sets')
                            .delete()
                            .eq('id', set.id)
                            .select();
                        
                        if (retryError) {
                            log(`   ‚ùå √öjrapr√≥b√°l√°s is sikertelen: ${retryError.message}`, 'error');
                        } else {
                            log(`   ‚úÖ √öjrapr√≥b√°l√°s sikeres!`, 'success');
                        }
                    } else {
                        log(`   ‚úÖ Szett t√∂r√∂lve!`, 'success');
                    }
                    
                    // Small delay between deletions
                    await new Promise(resolve => setTimeout(resolve, 200));
                }
                
                log('üîç V√©gellen≈ërz√©s...', 'info');
                await countSets();
                
            } catch (error) {
                log(`‚ùå T√∂rl√©si hiba: ${error.message}`, 'error');
                log(`üîç Stack trace: ${error.stack}`, 'error');
                updateStatus('‚ùå T√∂rl√©si hiba');
            }
        }
        
        // Auto-start
        updateStatus('üîÑ Ind√≠t√°s...');
        log('üöÄ Debug tool bet√∂ltve', 'success');
        log('üëÜ Kattints az "1Ô∏è‚É£ Alapok tesztel√©se" gombra a kezd√©shez!', 'info');
    </script>
</body>
</html>
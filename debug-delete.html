<!DOCTYPE html>
<html>
<head>
    <title>Debug T√∂rl√©s</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background: #f5f5f5; }
        .debug-block { background: white; margin: 10px 0; padding: 15px; border-radius: 8px; border-left: 4px solid #007bff; }
        .error { border-left-color: #dc3545; background: #fff5f5; }
        .success { border-left-color: #28a745; background: #f8fff8; }
        .warning { border-left-color: #ffc107; background: #fffef0; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 5px; overflow-x: auto; font-size: 12px; }
        button { padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; margin: 5px; }
        .delete-btn { background: #dc3545; }
        .select { width: 100%; padding: 8px; margin: 5px 0; }
    </style>
</head>
<body>
    <h1>üîç T√∂rl√©s Debug Tool</h1>
    
    <div class="debug-block">
        <h3>1. Szett v√°laszt√°sa t√∂rl√©shez</h3>
        <select id="setSelect" class="select">
            <option value="">Bet√∂lt√©s...</option>
        </select>
        <button onclick="analyzeSet()" class="delete-btn">üîç Szett elemz√©se</button>
        <button onclick="forceDeleteSet()" class="delete-btn">üí• K√©nyszer t√∂rl√©s</button>
    </div>
    
    <div id="debugOutput"></div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        const SUPABASE_URL = 'https://ycxqxdhaxehspypqbnpi.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InljeHF4ZGhheGVoc3B5cHFibnBpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMyMDMwMzEsImV4cCI6MjA2ODc3OTAzMX0.7RGVld6WOhNgeTA6xQc_U_eDXfMGzIshUlKV6j2Ru6g';
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        let allSets = [];
        
        function log(message, type = 'info') {
            const output = document.getElementById('debugOutput');
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : type === 'warning' ? 'warning' : '';
            output.innerHTML += `<div class="debug-block ${className}"><strong>${new Date().toLocaleTimeString()}</strong> - ${message}</div>`;
        }
        
        async function loadSets() {
            try {
                log('üîÑ Szettek bet√∂lt√©se...');
                const { data: sets, error } = await supabase
                    .from('flashcard_sets')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                if (error) {
                    log(`‚ùå Szettek bet√∂lt√©si hiba: ${error.message}`, 'error');
                    return;
                }
                
                allSets = sets || [];
                const select = document.getElementById('setSelect');
                select.innerHTML = '<option value="">V√°lassz egy szettet...</option>';
                
                sets.forEach(set => {
                    const isCNN10 = set.title && set.title.toLowerCase().includes('cnn10');
                    const option = document.createElement('option');
                    option.value = set.id;
                    option.textContent = `${set.title || 'N√©vtelen'} ${isCNN10 ? '(CNN10 - V√âDETT)' : ''}`;
                    if (isCNN10) option.disabled = true;
                    select.appendChild(option);
                });
                
                log(`‚úÖ ${sets.length} szett bet√∂ltve`, 'success');
                
            } catch (error) {
                log(`‚ùå √Åltal√°nos hiba: ${error.message}`, 'error');
            }
        }
        
        async function analyzeSet() {
            const setId = document.getElementById('setSelect').value;
            if (!setId) {
                log('‚ùå V√°lassz ki egy szettet!', 'error');
                return;
            }
            
            const set = allSets.find(s => s.id === setId);
            if (!set) {
                log('‚ùå Szett nem tal√°lhat√≥!', 'error');
                return;
            }
            
            log(`üîç Elemz√©s kezdete: "${set.title}" (${setId})`);
            
            try {
                // 1. Szett adatok
                log(`üìä <strong>Szett adatok:</strong><pre>${JSON.stringify(set, null, 2)}</pre>`);
                
                // 2. Flashcard kapcsolatok
                const { data: cardConnections, error: cardError } = await supabase
                    .from('flashcard_set_cards')
                    .select('*')
                    .eq('set_id', setId);
                
                if (cardError) {
                    log(`‚ùå K√°rtya kapcsolatok lek√©rdez√©si hiba: ${cardError.message}`, 'error');
                } else {
                    log(`üÉè <strong>K√°rtya kapcsolatok:</strong> ${cardConnections.length} db<pre>${JSON.stringify(cardConnections, null, 2)}</pre>`);
                }
                
                // 3. Kateg√≥ria kapcsolatok
                const { data: categoryConnections, error: catError } = await supabase
                    .from('flashcard_set_categories')
                    .select('*')
                    .eq('set_id', setId);
                
                if (catError) {
                    log(`‚ùå Kateg√≥ria kapcsolatok lek√©rdez√©si hiba: ${catError.message}`, 'error');
                } else {
                    log(`üè∑Ô∏è <strong>Kateg√≥ria kapcsolatok:</strong> ${categoryConnections.length} db<pre>${JSON.stringify(categoryConnections, null, 2)}</pre>`);
                }
                
                // 4. User sessions/progress kapcsolatok
                const { data: progressConnections, error: progressError } = await supabase
                    .from('user_card_progress')
                    .select('*')
                    .in('card_id', (cardConnections || []).map(c => c.card_id));
                
                if (progressError) {
                    log(`‚ùå Progress kapcsolatok lek√©rdez√©si hiba: ${progressError.message}`, 'error');
                } else {
                    log(`üìà <strong>User progress kapcsolatok:</strong> ${progressConnections.length} db<pre>${JSON.stringify(progressConnections, null, 2)}</pre>`);
                }
                
                // 5. Egy√©b lehets√©ges kapcsolatok ellen≈ërz√©se
                log('üîç <strong>Minden kapcsolat ellen≈ërizve.</strong> Ha vannak kapcsolatok, azokat el≈ëbb t√∂r√∂lni kell!');
                
            } catch (error) {
                log(`‚ùå Elemz√©si hiba: ${error.message}`, 'error');
            }
        }
        
        async function forceDeleteSet() {
            const setId = document.getElementById('setSelect').value;
            if (!setId) {
                log('‚ùå V√°lassz ki egy szettet!', 'error');
                return;
            }
            
            const set = allSets.find(s => s.id === setId);
            if (!set) {
                log('‚ùå Szett nem tal√°lhat√≥!', 'error');
                return;
            }
            
            if (set.title && set.title.toLowerCase().includes('cnn10')) {
                log('‚ùå CNN10 szett v√©dett!', 'error');
                return;
            }
            
            if (!confirm(`FIGYELEM! K√©nyszer t√∂rl√©s: "${set.title}"\n\nEz minden kapcsolatot t√∂r√∂l! Biztos vagy benne?`)) {
                return;
            }
            
            log(`üí• <strong>K√âNYSZER T√ñRL√âS KEZDETE:</strong> "${set.title}" (${setId})`, 'warning');
            
            try {
                // 1. User progress t√∂rl√©se
                log('üîÑ User progress t√∂rl√©se...');
                const { data: cardConnections } = await supabase
                    .from('flashcard_set_cards')
                    .select('card_id')
                    .eq('set_id', setId);
                
                if (cardConnections && cardConnections.length > 0) {
                    const cardIds = cardConnections.map(c => c.card_id);
                    const { error: progressDeleteError } = await supabase
                        .from('user_card_progress')
                        .delete()
                        .in('card_id', cardIds);
                    
                    if (progressDeleteError) {
                        log(`‚ö†Ô∏è User progress t√∂rl√©si hiba: ${progressDeleteError.message}`, 'warning');
                    } else {
                        log('‚úÖ User progress t√∂r√∂lve');
                    }
                }
                
                // 2. Flashcard kapcsolatok t√∂rl√©se
                log('üîÑ Flashcard kapcsolatok t√∂rl√©se...');
                const { error: cardDeleteError } = await supabase
                    .from('flashcard_set_cards')
                    .delete()
                    .eq('set_id', setId);
                
                if (cardDeleteError) {
                    log(`‚ùå Flashcard kapcsolatok t√∂rl√©si hiba: ${cardDeleteError.message}`, 'error');
                    return;
                } else {
                    log('‚úÖ Flashcard kapcsolatok t√∂r√∂lve');
                }
                
                // 3. Kateg√≥ria kapcsolatok t√∂rl√©se
                log('üîÑ Kateg√≥ria kapcsolatok t√∂rl√©se...');
                const { error: catDeleteError } = await supabase
                    .from('flashcard_set_categories')
                    .delete()
                    .eq('set_id', setId);
                
                if (catDeleteError) {
                    log(`‚ùå Kateg√≥ria kapcsolatok t√∂rl√©si hiba: ${catDeleteError.message}`, 'error');
                    return;
                } else {
                    log('‚úÖ Kateg√≥ria kapcsolatok t√∂r√∂lve');
                }
                
                // 4. V√©g√ºl a szett t√∂rl√©se
                log('üîÑ Szett t√∂rl√©se...');
                const { data: deletedSet, error: setDeleteError } = await supabase
                    .from('flashcard_sets')
                    .delete()
                    .eq('id', setId)
                    .select();
                
                if (setDeleteError) {
                    log(`‚ùå SZETT T√ñRL√âSI HIBA: ${setDeleteError.message}`, 'error');
                    log(`üîç <strong>Debug info:</strong><pre>${JSON.stringify(setDeleteError, null, 2)}</pre>`);
                    return;
                } else {
                    log(`üéâ <strong>SZETT SIKERESEN T√ñR√ñLVE!</strong><pre>${JSON.stringify(deletedSet, null, 2)}</pre>`, 'success');
                }
                
                // 5. Szettek √∫jrat√∂lt√©se
                await loadSets();
                
            } catch (error) {
                log(`‚ùå K√©nyszer t√∂rl√©si hiba: ${error.message}`, 'error');
                log(`üîç <strong>Stack trace:</strong><pre>${error.stack}</pre>`);
            }
        }
        
        // Auto-load
        loadSets();
    </script>
</body>
</html>
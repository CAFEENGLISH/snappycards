<!DOCTYPE html>
<html>
<head>
    <title>Teljes Adatbázis Elemzés</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background: #f5f5f5; }
        .section { background: white; margin: 15px 0; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .error { background: #fff5f5; border-left: 4px solid #dc3545; }
        .success { background: #f8fff8; border-left: 4px solid #28a745; }
        .warning { background: #fffef0; border-left: 4px solid #ffc107; }
        .info { background: #f0f8ff; border-left: 4px solid #007bff; }
        pre { background: #f8f9fa; padding: 15px; border-radius: 8px; overflow-x: auto; font-size: 12px; max-height: 300px; overflow-y: auto; }
        button { padding: 12px 24px; background: #007bff; color: white; border: none; border-radius: 6px; cursor: pointer; margin: 8px; font-weight: bold; }
        .delete-btn { background: #dc3545; }
        .warning-btn { background: #ffc107; color: #000; }
        .success-btn { background: #28a745; }
        h2 { color: #333; border-bottom: 2px solid #007bff; padding-bottom: 8px; }
        .highlight { background: #ffeb3b; padding: 2px 6px; border-radius: 3px; }
        .count { font-weight: bold; color: #007bff; font-size: 18px; }
    </style>
</head>
<body>
    <h1>🔍 Teljes Adatbázis Elemzés és Tisztítás</h1>
    
    <div class="section info">
        <h2>🚀 Gyors műveletek</h2>
        <button onclick="fullAnalysis()" class="success-btn">📊 Teljes elemzés</button>
        <button onclick="clearAllSets()" class="delete-btn">🧹 MINDEN szett törlése (CNN10 kivételével)</button>
        <button onclick="createCleanCNN10()" class="warning-btn">🔧 Tiszta CNN10 létrehozása</button>
        <button onclick="forceClearCache()" class="warning-btn">💾 Cache törlése</button>
    </div>

    <div id="analysisResults"></div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        const SUPABASE_URL = 'https://ycxqxdhaxehspypqbnpi.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InljeHF4ZGhheGVoc3B5cHFibnBpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMyMDMwMzEsImV4cCI6MjA2ODc3OTAzMX0.7RGVld6WOhNgeTA6xQc_U_eDXfMGzIshUlKV6j2Ru6g';
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        function logResult(title, content, type = 'info') {
            const results = document.getElementById('analysisResults');
            const sectionClass = type === 'error' ? 'error' : type === 'success' ? 'success' : type === 'warning' ? 'warning' : 'info';
            results.innerHTML += `
                <div class="section ${sectionClass}">
                    <h2>${title}</h2>
                    ${content}
                </div>
            `;
        }
        
        async function fullAnalysis() {
            document.getElementById('analysisResults').innerHTML = '';
            logResult('🔄 Elemzés kezdete...', 'Adatbázis teljes elemzése folyamatban...', 'info');
            
            try {
                // 1. Current user info
                const { data: { user }, error: authError } = await supabase.auth.getUser();
                if (authError || !user) {
                    logResult('👤 Felhasználó állapot', `<div class="warning">⚠️ Nincs bejelentkezve vagy auth hiba: ${authError?.message || 'Nincs user'}</div>`, 'warning');
                } else {
                    logResult('👤 Felhasználó állapot', `<div class="success">✅ Bejelentkezett user: <span class="highlight">${user.email}</span><br>User ID: <code>${user.id}</code></div>`, 'success');
                }
                
                // 2. Flashcard Sets Analysis
                const { data: allSets, error: setsError } = await supabase
                    .from('flashcard_sets')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                if (setsError) {
                    logResult('📚 Flashcard Sets', `<div class="error">❌ Hiba: ${setsError.message}</div>`, 'error');
                } else {
                    const cnn10Sets = allSets.filter(set => set.title && set.title.toLowerCase().includes('cnn'));
                    const otherSets = allSets.filter(set => !set.title || !set.title.toLowerCase().includes('cnn'));
                    
                    let content = `
                        <div class="count">📊 Összes szett: ${allSets.length} db</div>
                        <div class="count">🎯 CNN tartalmú szettek: ${cnn10Sets.length} db</div>
                        <div class="count">📚 Egyéb szettek: ${otherSets.length} db</div>
                        <br>
                        <h3>🎯 CNN szettek:</h3>
                        <pre>${JSON.stringify(cnn10Sets, null, 2)}</pre>
                        <h3>📚 Egyéb szettek:</h3>
                        <pre>${JSON.stringify(otherSets, null, 2)}</pre>
                    `;
                    logResult('📚 Flashcard Sets Elemzés', content, allSets.length > 0 ? 'info' : 'success');
                }
                
                // 3. Cards Analysis
                const { data: allCards, error: cardsError } = await supabase
                    .from('cards')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                if (cardsError) {
                    logResult('🃏 Cards', `<div class="error">❌ Hiba: ${cardsError.message}</div>`, 'error');
                } else {
                    let content = `
                        <div class="count">🃏 Összes kártya: ${allCards.length} db</div>
                        <h3>📋 Legutóbbi 5 kártya:</h3>
                        <pre>${JSON.stringify(allCards.slice(0, 5), null, 2)}</pre>
                    `;
                    logResult('🃏 Cards Elemzés', content, 'info');
                }
                
                // 4. Connections Analysis
                const { data: connections, error: connError } = await supabase
                    .from('flashcard_set_cards')
                    .select('*');
                
                if (connError) {
                    logResult('🔗 Kapcsolatok', `<div class="error">❌ Hiba: ${connError.message}</div>`, 'error');
                } else {
                    let content = `
                        <div class="count">🔗 Összes kapcsolat: ${connections.length} db</div>
                        <pre>${JSON.stringify(connections, null, 2)}</pre>
                    `;
                    logResult('🔗 Set-Card Kapcsolatok', content, 'info');
                }
                
                // 5. Categories Analysis
                const { data: categories, error: catError } = await supabase
                    .from('flashcard_set_categories')
                    .select('*');
                
                if (catError) {
                    logResult('🏷️ Kategóriák', `<div class="error">❌ Hiba: ${catError.message}</div>`, 'error');
                } else {
                    let content = `
                        <div class="count">🏷️ Kategória kapcsolatok: ${categories.length} db</div>
                        <pre>${JSON.stringify(categories, null, 2)}</pre>
                    `;
                    logResult('🏷️ Kategória Kapcsolatok', content, 'info');
                }
                
                // 6. Progress Analysis 
                const { data: progress, error: progressError } = await supabase
                    .from('user_card_progress')
                    .select('*')
                    .limit(50);
                
                if (progressError) {
                    logResult('📈 Progress', `<div class="error">❌ Hiba: ${progressError.message}</div>`, 'error');
                } else {
                    let content = `
                        <div class="count">📈 User progress bejegyzések: ${progress.length} db (első 50)</div>
                        <pre>${JSON.stringify(progress, null, 2)}</pre>
                    `;
                    logResult('📈 User Progress', content, 'info');
                }
                
                // 7. Storage Analysis (if any)
                try {
                    const { data: buckets, error: storageError } = await supabase.storage.listBuckets();
                    if (storageError) {
                        logResult('💾 Storage', `<div class="warning">⚠️ Storage hiba: ${storageError.message}</div>`, 'warning');
                    } else {
                        let content = `
                            <div class="count">💾 Storage buckets: ${buckets.length} db</div>
                            <pre>${JSON.stringify(buckets, null, 2)}</pre>
                        `;
                        logResult('💾 Storage Buckets', content, 'info');
                    }
                } catch (storageError) {
                    logResult('💾 Storage', `<div class="warning">⚠️ Storage nem elérhető: ${storageError.message}</div>`, 'warning');
                }
                
                logResult('✅ Elemzés befejezve', 'Minden adatbázis tábla elemezve!', 'success');
                
            } catch (error) {
                logResult('❌ Általános hiba', `<div class="error">Elemzési hiba: ${error.message}<br><pre>${error.stack}</pre></div>`, 'error');
            }
        }
        
        async function clearAllSets() {
            if (!confirm('🚨 FIGYELEM! Ez minden szettet töröl (CNN10 kivételével)!\n\nFolytatod?')) return;
            
            try {
                logResult('🧹 Tisztítás kezdete...', 'Minden nem-CNN szett törlése...', 'warning');
                
                // Get all sets
                const { data: allSets, error: setsError } = await supabase
                    .from('flashcard_sets')
                    .select('*');
                
                if (setsError) {
                    logResult('❌ Hiba', `Szettek lekérési hiba: ${setsError.message}`, 'error');
                    return;
                }
                
                const nonCNN10Sets = allSets.filter(set => 
                    !set.title || !set.title.toLowerCase().includes('cnn')
                );
                
                logResult('📋 Törlendő szettek', `${nonCNN10Sets.length} szett törlésre kerül:<pre>${JSON.stringify(nonCNN10Sets.map(s => ({id: s.id, title: s.title})), null, 2)}</pre>`, 'warning');
                
                for (const set of nonCNN10Sets) {
                    console.log(`Törlés: ${set.title} (${set.id})`);
                    
                    // Delete all connections first
                    await supabase.from('user_card_progress').delete().in('card_id', 
                        (await supabase.from('flashcard_set_cards').select('card_id').eq('set_id', set.id)).data?.map(c => c.card_id) || []
                    );
                    
                    await supabase.from('flashcard_set_cards').delete().eq('set_id', set.id);
                    await supabase.from('flashcard_set_categories').delete().eq('set_id', set.id);
                    
                    // Delete the set
                    const { error: deleteError } = await supabase
                        .from('flashcard_sets')
                        .delete()
                        .eq('id', set.id);
                    
                    if (deleteError) {
                        logResult('❌ Törlési hiba', `${set.title}: ${deleteError.message}`, 'error');
                    }
                }
                
                logResult('✅ Törlés befejezve', `${nonCNN10Sets.length} szett törölve!`, 'success');
                
                // Refresh analysis
                setTimeout(fullAnalysis, 1000);
                
            } catch (error) {
                logResult('❌ Törlési hiba', `Általános hiba: ${error.message}`, 'error');
            }
        }
        
        async function createCleanCNN10() {
            try {
                logResult('🔧 CNN10 létrehozása...', 'Tiszta CNN10 szett létrehozása...', 'info');
                
                const { data, error } = await supabase
                    .from('flashcard_sets')
                    .insert({
                        title: 'CNN10 - május 5',
                        description: 'CNN10 hírek tanulása',
                        language_a: 'Hungarian',
                        language_b: 'English',
                        language_a_code: 'hu',
                        language_b_code: 'en',
                        is_public: false,
                        creator_id: '00000000-0000-0000-0000-000000000000' // Neutral ID
                    })
                    .select()
                    .single();
                
                if (error) {
                    logResult('❌ CNN10 hiba', `Létrehozási hiba: ${error.message}`, 'error');
                } else {
                    logResult('✅ CNN10 létrehozva', `Új CNN10 szett:<pre>${JSON.stringify(data, null, 2)}</pre>`, 'success');
                }
                
            } catch (error) {
                logResult('❌ CNN10 hiba', `Általános hiba: ${error.message}`, 'error');
            }
        }
        
        async function forceClearCache() {
            // Clear browser cache
            if ('caches' in window) {
                const cacheNames = await caches.keys();
                await Promise.all(cacheNames.map(name => caches.delete(name)));
            }
            
            // Clear localStorage
            localStorage.clear();
            sessionStorage.clear();
            
            logResult('💾 Cache törölve', 'Browser cache és storage törölve. Frissítsd az oldalt!', 'success');
        }
        
        // Auto-run analysis
        fullAnalysis();
    </script>
</body>
</html>
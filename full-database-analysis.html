<!DOCTYPE html>
<html>
<head>
    <title>Teljes Adatb√°zis Elemz√©s</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background: #f5f5f5; }
        .section { background: white; margin: 15px 0; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .error { background: #fff5f5; border-left: 4px solid #dc3545; }
        .success { background: #f8fff8; border-left: 4px solid #28a745; }
        .warning { background: #fffef0; border-left: 4px solid #ffc107; }
        .info { background: #f0f8ff; border-left: 4px solid #007bff; }
        pre { background: #f8f9fa; padding: 15px; border-radius: 8px; overflow-x: auto; font-size: 12px; max-height: 300px; overflow-y: auto; }
        button { padding: 12px 24px; background: #007bff; color: white; border: none; border-radius: 6px; cursor: pointer; margin: 8px; font-weight: bold; }
        .delete-btn { background: #dc3545; }
        .warning-btn { background: #ffc107; color: #000; }
        .success-btn { background: #28a745; }
        h2 { color: #333; border-bottom: 2px solid #007bff; padding-bottom: 8px; }
        .highlight { background: #ffeb3b; padding: 2px 6px; border-radius: 3px; }
        .count { font-weight: bold; color: #007bff; font-size: 18px; }
    </style>
</head>
<body>
    <h1>üîç Teljes Adatb√°zis Elemz√©s √©s Tiszt√≠t√°s</h1>
    
    <div class="section info">
        <h2>üöÄ Gyors m≈±veletek</h2>
        <button onclick="fullAnalysis()" class="success-btn">üìä Teljes elemz√©s</button>
        <button onclick="clearAllSets()" class="delete-btn">üßπ MINDEN szett t√∂rl√©se (CNN10 kiv√©tel√©vel)</button>
        <button onclick="createCleanCNN10()" class="warning-btn">üîß Tiszta CNN10 l√©trehoz√°sa</button>
        <button onclick="forceClearCache()" class="warning-btn">üíæ Cache t√∂rl√©se</button>
    </div>

    <div id="analysisResults"></div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        const SUPABASE_URL = 'https://ycxqxdhaxehspypqbnpi.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InljeHF4ZGhheGVoc3B5cHFibnBpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMyMDMwMzEsImV4cCI6MjA2ODc3OTAzMX0.7RGVld6WOhNgeTA6xQc_U_eDXfMGzIshUlKV6j2Ru6g';
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        function logResult(title, content, type = 'info') {
            const results = document.getElementById('analysisResults');
            const sectionClass = type === 'error' ? 'error' : type === 'success' ? 'success' : type === 'warning' ? 'warning' : 'info';
            results.innerHTML += `
                <div class="section ${sectionClass}">
                    <h2>${title}</h2>
                    ${content}
                </div>
            `;
        }
        
        async function fullAnalysis() {
            document.getElementById('analysisResults').innerHTML = '';
            logResult('üîÑ Elemz√©s kezdete...', 'Adatb√°zis teljes elemz√©se folyamatban...', 'info');
            
            try {
                // 1. Current user info
                const { data: { user }, error: authError } = await supabase.auth.getUser();
                if (authError || !user) {
                    logResult('üë§ Felhaszn√°l√≥ √°llapot', `<div class="warning">‚ö†Ô∏è Nincs bejelentkezve vagy auth hiba: ${authError?.message || 'Nincs user'}</div>`, 'warning');
                } else {
                    logResult('üë§ Felhaszn√°l√≥ √°llapot', `<div class="success">‚úÖ Bejelentkezett user: <span class="highlight">${user.email}</span><br>User ID: <code>${user.id}</code></div>`, 'success');
                }
                
                // 2. Flashcard Sets Analysis
                const { data: allSets, error: setsError } = await supabase
                    .from('flashcard_sets')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                if (setsError) {
                    logResult('üìö Flashcard Sets', `<div class="error">‚ùå Hiba: ${setsError.message}</div>`, 'error');
                } else {
                    const cnn10Sets = allSets.filter(set => set.title && set.title.toLowerCase().includes('cnn'));
                    const otherSets = allSets.filter(set => !set.title || !set.title.toLowerCase().includes('cnn'));
                    
                    let content = `
                        <div class="count">üìä √ñsszes szett: ${allSets.length} db</div>
                        <div class="count">üéØ CNN tartalm√∫ szettek: ${cnn10Sets.length} db</div>
                        <div class="count">üìö Egy√©b szettek: ${otherSets.length} db</div>
                        <br>
                        <h3>üéØ CNN szettek:</h3>
                        <pre>${JSON.stringify(cnn10Sets, null, 2)}</pre>
                        <h3>üìö Egy√©b szettek:</h3>
                        <pre>${JSON.stringify(otherSets, null, 2)}</pre>
                    `;
                    logResult('üìö Flashcard Sets Elemz√©s', content, allSets.length > 0 ? 'info' : 'success');
                }
                
                // 3. Cards Analysis
                const { data: allCards, error: cardsError } = await supabase
                    .from('cards')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                if (cardsError) {
                    logResult('üÉè Cards', `<div class="error">‚ùå Hiba: ${cardsError.message}</div>`, 'error');
                } else {
                    let content = `
                        <div class="count">üÉè √ñsszes k√°rtya: ${allCards.length} db</div>
                        <h3>üìã Legut√≥bbi 5 k√°rtya:</h3>
                        <pre>${JSON.stringify(allCards.slice(0, 5), null, 2)}</pre>
                    `;
                    logResult('üÉè Cards Elemz√©s', content, 'info');
                }
                
                // 4. Connections Analysis
                const { data: connections, error: connError } = await supabase
                    .from('flashcard_set_cards')
                    .select('*');
                
                if (connError) {
                    logResult('üîó Kapcsolatok', `<div class="error">‚ùå Hiba: ${connError.message}</div>`, 'error');
                } else {
                    let content = `
                        <div class="count">üîó √ñsszes kapcsolat: ${connections.length} db</div>
                        <pre>${JSON.stringify(connections, null, 2)}</pre>
                    `;
                    logResult('üîó Set-Card Kapcsolatok', content, 'info');
                }
                
                // 5. Categories Analysis
                const { data: categories, error: catError } = await supabase
                    .from('flashcard_set_categories')
                    .select('*');
                
                if (catError) {
                    logResult('üè∑Ô∏è Kateg√≥ri√°k', `<div class="error">‚ùå Hiba: ${catError.message}</div>`, 'error');
                } else {
                    let content = `
                        <div class="count">üè∑Ô∏è Kateg√≥ria kapcsolatok: ${categories.length} db</div>
                        <pre>${JSON.stringify(categories, null, 2)}</pre>
                    `;
                    logResult('üè∑Ô∏è Kateg√≥ria Kapcsolatok', content, 'info');
                }
                
                // 6. Progress Analysis 
                const { data: progress, error: progressError } = await supabase
                    .from('user_card_progress')
                    .select('*')
                    .limit(50);
                
                if (progressError) {
                    logResult('üìà Progress', `<div class="error">‚ùå Hiba: ${progressError.message}</div>`, 'error');
                } else {
                    let content = `
                        <div class="count">üìà User progress bejegyz√©sek: ${progress.length} db (els≈ë 50)</div>
                        <pre>${JSON.stringify(progress, null, 2)}</pre>
                    `;
                    logResult('üìà User Progress', content, 'info');
                }
                
                // 7. Storage Analysis (if any)
                try {
                    const { data: buckets, error: storageError } = await supabase.storage.listBuckets();
                    if (storageError) {
                        logResult('üíæ Storage', `<div class="warning">‚ö†Ô∏è Storage hiba: ${storageError.message}</div>`, 'warning');
                    } else {
                        let content = `
                            <div class="count">üíæ Storage buckets: ${buckets.length} db</div>
                            <pre>${JSON.stringify(buckets, null, 2)}</pre>
                        `;
                        logResult('üíæ Storage Buckets', content, 'info');
                    }
                } catch (storageError) {
                    logResult('üíæ Storage', `<div class="warning">‚ö†Ô∏è Storage nem el√©rhet≈ë: ${storageError.message}</div>`, 'warning');
                }
                
                logResult('‚úÖ Elemz√©s befejezve', 'Minden adatb√°zis t√°bla elemezve!', 'success');
                
            } catch (error) {
                logResult('‚ùå √Åltal√°nos hiba', `<div class="error">Elemz√©si hiba: ${error.message}<br><pre>${error.stack}</pre></div>`, 'error');
            }
        }
        
        async function clearAllSets() {
            if (!confirm('üö® FIGYELEM! Ez minden szettet t√∂r√∂l (CNN10 kiv√©tel√©vel)!\n\nFolytatod?')) return;
            
            try {
                logResult('üßπ Tiszt√≠t√°s kezdete...', 'Minden nem-CNN szett t√∂rl√©se...', 'warning');
                
                // Get all sets
                const { data: allSets, error: setsError } = await supabase
                    .from('flashcard_sets')
                    .select('*');
                
                if (setsError) {
                    logResult('‚ùå Hiba', `Szettek lek√©r√©si hiba: ${setsError.message}`, 'error');
                    return;
                }
                
                const nonCNN10Sets = allSets.filter(set => 
                    !set.title || !set.title.toLowerCase().includes('cnn')
                );
                
                logResult('üìã T√∂rlend≈ë szettek', `${nonCNN10Sets.length} szett t√∂rl√©sre ker√ºl:<pre>${JSON.stringify(nonCNN10Sets.map(s => ({id: s.id, title: s.title})), null, 2)}</pre>`, 'warning');
                
                for (const set of nonCNN10Sets) {
                    console.log(`T√∂rl√©s: ${set.title} (${set.id})`);
                    
                    // Delete all connections first
                    await supabase.from('user_card_progress').delete().in('card_id', 
                        (await supabase.from('flashcard_set_cards').select('card_id').eq('set_id', set.id)).data?.map(c => c.card_id) || []
                    );
                    
                    await supabase.from('flashcard_set_cards').delete().eq('set_id', set.id);
                    await supabase.from('flashcard_set_categories').delete().eq('set_id', set.id);
                    
                    // Delete the set
                    const { error: deleteError } = await supabase
                        .from('flashcard_sets')
                        .delete()
                        .eq('id', set.id);
                    
                    if (deleteError) {
                        logResult('‚ùå T√∂rl√©si hiba', `${set.title}: ${deleteError.message}`, 'error');
                    }
                }
                
                logResult('‚úÖ T√∂rl√©s befejezve', `${nonCNN10Sets.length} szett t√∂r√∂lve!`, 'success');
                
                // Refresh analysis
                setTimeout(fullAnalysis, 1000);
                
            } catch (error) {
                logResult('‚ùå T√∂rl√©si hiba', `√Åltal√°nos hiba: ${error.message}`, 'error');
            }
        }
        
        async function createCleanCNN10() {
            try {
                logResult('üîß CNN10 l√©trehoz√°sa...', 'Tiszta CNN10 szett l√©trehoz√°sa...', 'info');
                
                const { data, error } = await supabase
                    .from('flashcard_sets')
                    .insert({
                        title: 'CNN10 - m√°jus 5',
                        description: 'CNN10 h√≠rek tanul√°sa',
                        language_a: 'Hungarian',
                        language_b: 'English',
                        language_a_code: 'hu',
                        language_b_code: 'en',
                        is_public: false,
                        creator_id: '00000000-0000-0000-0000-000000000000' // Neutral ID
                    })
                    .select()
                    .single();
                
                if (error) {
                    logResult('‚ùå CNN10 hiba', `L√©trehoz√°si hiba: ${error.message}`, 'error');
                } else {
                    logResult('‚úÖ CNN10 l√©trehozva', `√öj CNN10 szett:<pre>${JSON.stringify(data, null, 2)}</pre>`, 'success');
                }
                
            } catch (error) {
                logResult('‚ùå CNN10 hiba', `√Åltal√°nos hiba: ${error.message}`, 'error');
            }
        }
        
        async function forceClearCache() {
            // Clear browser cache
            if ('caches' in window) {
                const cacheNames = await caches.keys();
                await Promise.all(cacheNames.map(name => caches.delete(name)));
            }
            
            // Clear localStorage
            localStorage.clear();
            sessionStorage.clear();
            
            logResult('üíæ Cache t√∂r√∂lve', 'Browser cache √©s storage t√∂r√∂lve. Friss√≠tsd az oldalt!', 'success');
        }
        
        // Auto-run analysis
        fullAnalysis();
    </script>
</body>
</html>
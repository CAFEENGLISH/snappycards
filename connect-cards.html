<!DOCTYPE html>
<html>
<head>
    <title>K√°rty√°k √ñsszekapcsol√°sa</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .card { border: 1px solid #ddd; padding: 10px; margin: 5px 0; border-radius: 5px; }
        .success { background: #d4edda; border-color: #c3e6cb; color: #155724; }
        .error { background: #f8d7da; border-color: #f5c6cb; color: #721c24; }
        .info { background: #d1ecf1; border-color: #bee5eb; color: #0c5460; }
        button { padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; margin: 5px; }
        button:hover { background: #0056b3; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 5px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>üîó K√°rty√°k √ñsszekapcsol√°sa CNN10 Szetttel</h1>
    <div id="results"></div>
    <button onclick="connectCards()" id="connectBtn">üîó K√°rty√°k √ñsszekapcsol√°sa</button>

    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="config/supabase.js"></script>
    <script>
        // Supabase client from central configuration
        const supabase = window.supabaseClient;
        
        let cnn10SetId = null;
        let availableCards = [];
        
        async function analyzeDatabase() {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '<div class="info">üîç Adatb√°zis elemz√©se folyamatban...</div>';
            
            try {
                // 1. CNN10 szett keres√©se
                console.log('üîç 1. CNN10 szett keres√©se...');
                const { data: sets, error: setsError } = await supabase
                    .from('flashcard_sets')
                    .select('*')
                    .or('title.ilike.%CNN10%,title.ilike.%cnn10%');
                
                if (setsError) {
                    resultsDiv.innerHTML += `<div class="error">‚ùå Szettek lek√©rdez√©si hiba: ${setsError.message}</div>`;
                    return;
                }
                
                if (sets.length === 0) {
                    // Debug: √∂sszes szett lek√©r√©se
                    console.log('üîç Debug: √∂sszes szett lek√©r√©se...');
                    const { data: allSets, error: allSetsError } = await supabase
                        .from('flashcard_sets')
                        .select('id, title')
                        .limit(10);
                    
                    resultsDiv.innerHTML += `<div class="error">‚ùå Nem tal√°ltam CNN10 szetet!</div>`;
                    resultsDiv.innerHTML += `<div class="info">üîç <strong>Debug - Els≈ë 10 szett az adatb√°zisban:</strong><br>`;
                    if (allSets && allSets.length > 0) {
                        allSets.forEach(set => {
                            resultsDiv.innerHTML += `‚Ä¢ <strong>${set.title}</strong> (ID: ${set.id})<br>`;
                        });
                    } else {
                        resultsDiv.innerHTML += '‚Ä¢ Nincs szett az adatb√°zisban!<br>';
                    }
                    resultsDiv.innerHTML += `</div>`;
                    return;
                }
                
                cnn10SetId = sets[0].id;
                resultsDiv.innerHTML += `<div class="success">‚úÖ CNN10 szett tal√°lva: <strong>${sets[0].title}</strong><br>ID: <code>${cnn10SetId}</code></div>`;
                
                // 2. Megl√©v≈ë kapcsolatok ellen≈ërz√©se
                console.log('üîç 2. Megl√©v≈ë kapcsolatok...');
                const { data: existingConnections, error: connectionsError } = await supabase
                    .from('flashcard_set_cards')
                    .select('*')
                    .eq('set_id', cnn10SetId);
                
                if (connectionsError) {
                    resultsDiv.innerHTML += `<div class="error">‚ùå Kapcsolatok lek√©rdez√©si hiba: ${connectionsError.message}</div>`;
                    return;
                }
                
                resultsDiv.innerHTML += `<div class="info">üìã Megl√©v≈ë kapcsolatok: <strong>${existingConnections.length} db</strong></div>`;
                
                // 3. √ñsszes k√°rtya lek√©rdez√©se
                console.log('üîç 3. √ñsszes k√°rtya...');
                const { data: allCards, error: cardsError } = await supabase
                    .from('cards')
                    .select('*')
                    .order('created_at', { ascending: true });
                
                if (cardsError) {
                    resultsDiv.innerHTML += `<div class="error">‚ùå K√°rty√°k lek√©rdez√©si hiba: ${cardsError.message}</div>`;
                    return;
                }
                
                resultsDiv.innerHTML += `<div class="info">üÉè √ñsszes k√°rtya: <strong>${allCards.length} db</strong></div>`;
                
                // 4. Szabad k√°rty√°k (nem kapcsol√≥dnak a CNN10 szetthez)
                const connectedCardIds = existingConnections.map(conn => conn.card_id);
                availableCards = allCards.filter(card => !connectedCardIds.includes(card.id));
                
                resultsDiv.innerHTML += `<div class="info">üÜì Szabad k√°rty√°k: <strong>${availableCards.length} db</strong></div>`;
                
                if (availableCards.length > 0) {
                    resultsDiv.innerHTML += '<h3>üìã Szabad k√°rty√°k list√°ja:</h3>';
                    availableCards.forEach((card, index) => {
                        resultsDiv.innerHTML += `
                            <div class="card">
                                <strong>${index + 1}. ${card.title || 'N/A'}</strong> ‚Üí 
                                <strong>${card.english_title || 'N/A'}</strong><br>
                                <small>ID: ${card.id} | L√©trehozva: ${new Date(card.created_at).toLocaleString()}</small>
                            </div>
                        `;
                    });
                    
                    document.getElementById('connectBtn').style.display = 'block';
                } else {
                    resultsDiv.innerHTML += `<div class="info">‚ÑπÔ∏è Nincsenek szabad k√°rty√°k az √∂sszekapcsol√°shoz.</div>`;
                    document.getElementById('connectBtn').style.display = 'none';
                }
                
            } catch (error) {
                console.error('Elemz√©si hiba:', error);
                resultsDiv.innerHTML += `<div class="error">‚ùå √Åltal√°nos hiba: ${error.message}</div>`;
            }
        }
        
        async function connectCards() {
            const resultsDiv = document.getElementById('results');
            const connectBtn = document.getElementById('connectBtn');
            
            if (!cnn10SetId || availableCards.length === 0) {
                resultsDiv.innerHTML += `<div class="error">‚ùå Nincs szett ID vagy nincsenek k√°rty√°k!</div>`;
                return;
            }
            
            connectBtn.disabled = true;
            connectBtn.textContent = '‚è≥ √ñsszekapcsol√°s...';
            
            try {
                resultsDiv.innerHTML += `<div class="info">üîó ${availableCards.length} k√°rtya √∂sszekapcsol√°sa a CNN10 szetttel...</div>`;
                
                let successCount = 0;
                let errorCount = 0;
                
                for (let i = 0; i < availableCards.length; i++) {
                    const card = availableCards[i];
                    
                    try {
                        const { error: linkError } = await supabase
                            .from('flashcard_set_cards')
                            .insert({
                                set_id: cnn10SetId,
                                card_id: card.id,
                                position: i + 1
                            });
                        
                        if (linkError) {
                            console.error(`Hiba a ${card.title} k√°rtya √∂sszekapcsol√°sakor:`, linkError);
                            errorCount++;
                        } else {
                            console.log(`‚úÖ Sikeresen √∂sszekapcsolt: ${card.title}`);
                            successCount++;
                        }
                        
                    } catch (cardError) {
                        console.error(`Kiv√©tel a ${card.title} k√°rtya √∂sszekapcsol√°sakor:`, cardError);
                        errorCount++;
                    }
                }
                
                resultsDiv.innerHTML += `
                    <div class="success">
                        üéâ <strong>√ñsszekapcsol√°s befejezve!</strong><br>
                        ‚úÖ Sikeres: ${successCount} db<br>
                        ‚ùå Hib√°s: ${errorCount} db
                    </div>
                `;
                
                if (successCount > 0) {
                    resultsDiv.innerHTML += `
                        <div class="info">
                            üöÄ <strong>Most m√°r m≈±k√∂dni fog a SlotMachine!</strong><br>
                            Menj vissza a dashboard-ra √©s pr√≥b√°ld ki a CNN10 szettet!
                        </div>
                    `;
                }
                
            } catch (error) {
                console.error('√ñsszekapcsol√°si hiba:', error);
                resultsDiv.innerHTML += `<div class="error">‚ùå √ñsszekapcsol√°si hiba: ${error.message}</div>`;
            } finally {
                connectBtn.disabled = false;
                connectBtn.textContent = 'üîó K√°rty√°k √ñsszekapcsol√°sa';
            }
        }
        
        // Automatikus elemz√©s ind√≠t√°sa
        analyzeDatabase();
    </script>
</body>
</html>
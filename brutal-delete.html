<!DOCTYPE html>
<html>
<head>
    <title>Brut√°lis T√∂rl√©s</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background: #1a1a1a; color: white; }
        .container { max-width: 1000px; margin: 0 auto; }
        .step { background: #2d2d2d; padding: 20px; margin: 15px 0; border-radius: 10px; border-left: 5px solid #333; }
        .step.active { border-left-color: #ff9800; background: #3d2f00; }
        .step.success { border-left-color: #4caf50; background: #1b4332; }
        .step.error { border-left-color: #f44336; background: #4d1f1f; }
        .step.info { border-left-color: #2196f3; background: #1a2040; }
        
        .count { font-size: 48px; font-weight: bold; text-align: center; margin: 30px 0; }
        .count.before { color: #f44336; }
        .count.after { color: #4caf50; }
        
        button { padding: 20px 40px; font-size: 20px; font-weight: bold; border: none; border-radius: 10px; cursor: pointer; margin: 15px; }
        .nuke-btn { background: #f44336; color: white; }
        .nuke-btn:hover { background: #d32f2f; }
        .check-btn { background: #2196f3; color: white; }
        .check-btn:hover { background: #1976d2; }
        
        pre { background: #1e1e1e; padding: 15px; border-radius: 8px; font-size: 12px; max-height: 300px; overflow-y: auto; border: 1px solid #444; }
        h1 { text-align: center; color: #f44336; text-transform: uppercase; letter-spacing: 2px; }
        .warning { background: #ff9800; color: #000; padding: 20px; border-radius: 10px; margin: 20px 0; text-align: center; font-weight: bold; font-size: 18px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üí• BRUT√ÅLIS ADATB√ÅZIS TISZT√çT√ÅS üí•</h1>
        
        <div class="warning">
            ‚ö†Ô∏è FIGYELEM! Ez minden nemk√≠v√°nt adatot v√©glegesen t√∂r√∂l!<br>
            Csak CNN szettek maradnak meg!
        </div>
        
        <div style="text-align: center;">
            <button onclick="brutalCheck()" class="check-btn">üîç JELENLEGI √ÅLLAPOT</button>
            <button onclick="brutalDelete()" class="nuke-btn">üí£ NUKLE√ÅRIS T√ñRL√âS</button>
        </div>
        
        <div id="results"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        const SUPABASE_URL = 'https://ycxqxdhaxehspypqbnpi.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InljeHF4ZGhheGVoc3B5cHFibnBpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMyMDMwMzEsImV4cCI6MjA2ODc3OTAzMX0.7RGVld6WOhNgeTA6xQc_U_eDXfMGzIshUlKV6j2Ru6g';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        let stepIndex = 0;
        
        function addStep(title, content, type = 'info') {
            stepIndex++;
            const results = document.getElementById('results');
            const timestamp = new Date().toLocaleTimeString();
            results.innerHTML += `
                <div class="step ${type}">
                    <h3>[${stepIndex}] ${timestamp} - ${title}</h3>
                    ${content}
                </div>
            `;
            results.scrollTop = results.scrollHeight;
            console.log(`[${stepIndex}] ${title}: ${content.replace(/<[^>]*>/g, '')}`);
        }
        
        async function brutalCheck() {
            document.getElementById('results').innerHTML = '';
            stepIndex = 0;
            
            addStep('üîç JELENLEGI √ÅLLAPOT ELLEN≈êRZ√âSE', 'Adatb√°zis tartalom vizsg√°lata...', 'active');
            
            try {
                // Check flashcard_sets
                const { data: allSets, error: setsError } = await supabase
                    .from('flashcard_sets')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                if (setsError) {
                    addStep('‚ùå HIBA', `Szettek lek√©rdez√©si hiba: ${setsError.message}`, 'error');
                    return;
                }
                
                const cnnSets = allSets.filter(set => set.title && set.title.toLowerCase().includes('cnn'));
                const badSets = allSets.filter(set => !set.title || !set.title.toLowerCase().includes('cnn'));
                
                addStep('üìä SZETTEK √ÅLLAPOTA', `
                    <div class="count before">${badSets.length}</div>
                    <p style="text-align: center;">T√ñRLEND≈ê SZETT</p>
                    <h4>üóëÔ∏è T√∂rlend≈ë szettek:</h4>
                    <pre>${JSON.stringify(badSets.map(s => ({id: s.id, title: s.title})), null, 2)}</pre>
                    <h4>üéØ CNN szettek (megmaradnak):</h4>
                    <pre>${JSON.stringify(cnnSets.map(s => ({id: s.id, title: s.title})), null, 2)}</pre>
                `, badSets.length > 0 ? 'error' : 'success');
                
                // Check connections
                const { data: connections, error: connError } = await supabase
                    .from('flashcard_set_cards')
                    .select('*');
                
                if (!connError) {
                    const badConnections = connections.filter(conn => 
                        badSets.some(set => set.id === conn.set_id)
                    );
                    addStep('üîó KAPCSOLATOK', `
                        <p>√ñsszes kapcsolat: ${connections.length} db</p>
                        <p>T√∂rlend≈ë kapcsolat: ${badConnections.length} db</p>
                        <pre>${JSON.stringify(badConnections, null, 2)}</pre>
                    `, badConnections.length > 0 ? 'error' : 'success');
                }
                
                // Check categories
                const { data: categories, error: catError } = await supabase
                    .from('flashcard_set_categories')
                    .select('*');
                
                if (!catError) {
                    const badCategories = categories.filter(cat => 
                        badSets.some(set => set.id === cat.set_id)
                    );
                    addStep('üè∑Ô∏è KATEG√ìRI√ÅK', `
                        <p>√ñsszes kateg√≥ria kapcsolat: ${categories.length} db</p>
                        <p>T√∂rlend≈ë kateg√≥ria kapcsolat: ${badCategories.length} db</p>
                        <pre>${JSON.stringify(badCategories, null, 2)}</pre>
                    `, badCategories.length > 0 ? 'error' : 'success');
                }
                
                // Check cards
                const { data: cards, error: cardsError } = await supabase
                    .from('cards')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                if (!cardsError) {
                    addStep('üÉè K√ÅRTY√ÅK', `
                        <p>√ñsszes k√°rtya: ${cards.length} db</p>
                        <p>Legut√≥bbi 3 k√°rtya:</p>
                        <pre>${JSON.stringify(cards.slice(0, 3).map(c => ({id: c.id, title: c.title, english_title: c.english_title})), null, 2)}</pre>
                    `, 'info');
                }
                
                if (badSets.length === 0) {
                    addStep('‚úÖ TISZTA', 'Minden rendben! Nincs mit t√∂r√∂lni.', 'success');
                } else {
                    addStep('üö® AKCI√ì SZ√úKS√âGES', `${badSets.length} szett √©s kapcsolataik t√∂rl√©sre v√°rnak!`, 'error');
                }
                
            } catch (error) {
                addStep('‚ùå KRITIKUS HIBA', `${error.message}<pre>${error.stack}</pre>`, 'error');
            }
        }
        
        async function brutalDelete() {
            if (!confirm('üö® BRUT√ÅLIS T√ñRL√âS!\n\nEz V√âGLEGESEN t√∂r√∂l minden nemk√≠v√°nt szettet √©s kapcsolatot!\n\nFOLYTATOD?')) {
                return;
            }
            
            document.getElementById('results').innerHTML = '';
            stepIndex = 0;
            
            addStep('üí£ NUKLE√ÅRIS T√ñRL√âS KEZDETE', 'Minden nemk√≠v√°nt adat megsemmis√≠t√©se...', 'active');
            
            try {
                // STEP 1: Get all bad sets
                addStep('üéØ 1. C√âLPONTOK AZONOS√çT√ÅSA', 'T√∂rlend≈ë szettek keres√©se...', 'active');
                
                const { data: allSets, error: setsError } = await supabase
                    .from('flashcard_sets')
                    .select('*');
                
                if (setsError) {
                    addStep('‚ùå HIBA', `Szettek lek√©rdez√©si hiba: ${setsError.message}`, 'error');
                    return;
                }
                
                const badSets = allSets.filter(set => !set.title || !set.title.toLowerCase().includes('cnn'));
                const badSetIds = badSets.map(set => set.id);
                
                addStep('üéØ C√âLPONTOK AZONOS√çTVA', `
                    <p><strong>${badSets.length}</strong> szett t√∂rl√©sre jel√∂lve:</p>
                    <pre>${JSON.stringify(badSets.map(s => ({id: s.id, title: s.title})), null, 2)}</pre>
                `, badSets.length > 0 ? 'error' : 'success');
                
                if (badSets.length === 0) {
                    addStep('‚úÖ NINCS TEEND≈ê', 'Minden szett clean! Nincs mit t√∂r√∂lni.', 'success');
                    return;
                }
                
                // STEP 2: Delete user_card_progress for cards in bad sets
                addStep('üßπ 2. USER PROGRESS T√ñRL√âSE', 'Felhaszn√°l√≥i halad√°s t√∂rl√©se...', 'active');
                
                const { data: badConnections } = await supabase
                    .from('flashcard_set_cards')
                    .select('card_id')
                    .in('set_id', badSetIds);
                
                if (badConnections && badConnections.length > 0) {
                    const cardIds = badConnections.map(c => c.card_id);
                    const { data: deletedProgress, error: progressError } = await supabase
                        .from('user_card_progress')
                        .delete()
                        .in('card_id', cardIds)
                        .select();
                    
                    if (progressError) {
                        addStep('‚ö†Ô∏è PROGRESS HIBA', `${progressError.message}`, 'error');
                    } else {
                        addStep('‚úÖ PROGRESS T√ñR√ñLVE', `${deletedProgress?.length || 0} progress bejegyz√©s t√∂r√∂lve`, 'success');
                    }
                }
                
                // STEP 3: Delete flashcard_set_cards
                addStep('üîó 3. SET-CARD KAPCSOLATOK T√ñRL√âSE', 'K√°rtya kapcsolatok t√∂rl√©se...', 'active');
                
                const { data: deletedConnections, error: connectionsError } = await supabase
                    .from('flashcard_set_cards')
                    .delete()
                    .in('set_id', badSetIds)
                    .select();
                
                if (connectionsError) {
                    addStep('‚ùå KAPCSOLATOK HIBA', `${connectionsError.message}`, 'error');
                } else {
                    addStep('‚úÖ KAPCSOLATOK T√ñR√ñLVE', `${deletedConnections?.length || 0} kapcsolat t√∂r√∂lve`, 'success');
                }
                
                // STEP 4: Delete flashcard_set_categories
                addStep('üè∑Ô∏è 4. KATEG√ìRIA KAPCSOLATOK T√ñRL√âSE', 'Kateg√≥ria kapcsolatok t√∂rl√©se...', 'active');
                
                const { data: deletedCategories, error: categoriesError } = await supabase
                    .from('flashcard_set_categories')
                    .delete()
                    .in('set_id', badSetIds)
                    .select();
                
                if (categoriesError) {
                    addStep('‚ùå KATEG√ìRI√ÅK HIBA', `${categoriesError.message}`, 'error');
                } else {
                    addStep('‚úÖ KATEG√ìRI√ÅK T√ñR√ñLVE', `${deletedCategories?.length || 0} kateg√≥ria kapcsolat t√∂r√∂lve`, 'success');
                }
                
                // STEP 5: Delete the sets themselves
                addStep('üí• 5. SZETTEK MEGSEMMIS√çT√âSE', 'Flashcard szettek t√∂rl√©se...', 'active');
                
                let successCount = 0;
                let errorCount = 0;
                
                for (let i = 0; i < badSets.length; i++) {
                    const set = badSets[i];
                    
                    const { data: deletedSet, error: setError } = await supabase
                        .from('flashcard_sets')
                        .delete()
                        .eq('id', set.id)
                        .select();
                    
                    if (setError) {
                        addStep(`‚ùå SZETT HIBA [${i+1}/${badSets.length}]`, `"${set.title}": ${setError.message}`, 'error');
                        errorCount++;
                    } else if (deletedSet && deletedSet.length > 0) {
                        addStep(`üí• SZETT MEGSEMMIS√çTVE [${i+1}/${badSets.length}]`, `"${set.title}" v√©glegesen t√∂r√∂lve`, 'success');
                        successCount++;
                    } else {
                        addStep(`‚ö†Ô∏è SZETT ST√ÅTUSZ [${i+1}/${badSets.length}]`, `"${set.title}" nem tal√°lhat√≥ (m√°r t√∂r√∂lve?)`, 'info');
                    }
                    
                    // Small delay
                    await new Promise(resolve => setTimeout(resolve, 200));
                }
                
                // FINAL VERIFICATION
                addStep('üîç 6. V√âGELLEN≈êRZ√âS', 'Eredm√©ny verific√°l√°sa...', 'active');
                
                const { data: finalSets, error: finalError } = await supabase
                    .from('flashcard_sets')
                    .select('*');
                
                if (finalError) {
                    addStep('‚ùå V√âGELLEN≈êRZ√âSI HIBA', `${finalError.message}`, 'error');
                } else {
                    const remainingBad = finalSets.filter(set => !set.title || !set.title.toLowerCase().includes('cnn'));
                    const remainingGood = finalSets.filter(set => set.title && set.title.toLowerCase().includes('cnn'));
                    
                    if (remainingBad.length === 0) {
                        addStep('üéâ MISSZI√ì TELJES√çTVE', `
                            <div class="count after">${remainingGood.length}</div>
                            <p style="text-align: center;">TISZTA CNN SZETT MARADT</p>
                            <p style="text-align: center; font-size: 20px; color: #4caf50;">
                                <strong>SIKERES T√ñRL√âS!</strong><br>
                                ${successCount} szett t√∂r√∂lve, ${errorCount} hiba
                            </p>
                            <h4>Megmaradt szettek:</h4>
                            <pre>${JSON.stringify(remainingGood.map(s => ({id: s.id, title: s.title})), null, 2)}</pre>
                        `, 'success');
                    } else {
                        addStep('‚ö†Ô∏è R√âSZLEGES SIKER', `
                            <p><strong>${remainingBad.length}</strong> szett m√©g mindig l√©tezik!</p>
                            <pre>${JSON.stringify(remainingBad.map(s => ({id: s.id, title: s.title})), null, 2)}</pre>
                        `, 'error');
                    }
                }
                
                addStep('üìã √ñSSZEFOGLAL√ì', `
                    <h4>T√∂rl√©si statisztik√°k:</h4>
                    <p>‚úÖ Sikeresen t√∂r√∂lve: ${successCount} szett</p>
                    <p>‚ùå Hib√°k: ${errorCount} szett</p>
                    <p>üîó Kapcsolatok t√∂r√∂lve: ${deletedConnections?.length || 0} db</p>
                    <p>üè∑Ô∏è Kateg√≥ri√°k t√∂r√∂lve: ${deletedCategories?.length || 0} db</p>
                `, successCount > 0 ? 'success' : 'info');
                
            } catch (error) {
                addStep('üíÄ KATASZTROF√ÅLIS HIBA', `${error.message}<pre>${error.stack}</pre>`, 'error');
            }
        }
        
        // Auto-check on load
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(brutalCheck, 1000);
        });
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üéì Szettek Kezel√©se - Iskola Admin</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: Inter, sans-serif;
            background: #f8fafc;
            min-height: 100vh;
        }
        
        .header {
            background: white;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header h1 {
            color: #1e293b;
            font-size: 1.5rem;
        }
        
        .back-btn {
            background: #7c3aed;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 10px 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
        }
        
        .back-btn:hover {
            background: #6d28d9;
        }
        
        .main-content {
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .search-filters {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        
        .search-row {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .search-input {
            flex: 1;
            min-width: 200px;
            padding: 10px 12px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
        }
        
        .search-input:focus {
            outline: none;
            border-color: #7c3aed;
            box-shadow: 0 0 0 3px rgba(124, 58, 237, 0.1);
        }
        
        .sets-table {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th {
            background: #f8fafc;
            padding: 15px;
            text-align: left;
            font-weight: 600;
            color: #374151;
            border-bottom: 1px solid #e5e7eb;
        }
        
        td {
            padding: 15px;
            border-bottom: 1px solid #f1f5f9;
            vertical-align: top;
        }
        
        tr:hover {
            background: #f8fafc;
        }
        
        .set-name {
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 4px;
        }
        
        .set-description {
            color: #64748b;
            font-size: 12px;
        }
        
        .cefr-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .cefr-a1 { background: #fef3c7; color: #92400e; }
        .cefr-a2 { background: #fed7aa; color: #c2410c; }
        .cefr-b1 { background: #dbeafe; color: #1d4ed8; }
        .cefr-b2 { background: #e0e7ff; color: #3730a3; }
        .cefr-c1 { background: #f3e8ff; color: #7c2d12; }
        .cefr-c2 { background: #fce7f3; color: #be185d; }
        
        .student-count {
            color: #7c3aed;
            font-weight: 600;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #64748b;
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #64748b;
        }
        
        .empty-state h3 {
            margin-bottom: 8px;
            color: #374151;
        }
        
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            border-radius: 12px;
            padding: 16px 20px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            z-index: 10000;
            display: none;
        }
        
        .toast.success { border-left: 4px solid #10b981; }
        .toast.error { border-left: 4px solid #ef4444; }
        
        @media (max-width: 768px) {
            .search-row {
                flex-direction: column;
                align-items: stretch;
            }
            
            .search-input {
                min-width: auto;
            }
            
            table {
                font-size: 14px;
            }
            
            th, td {
                padding: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üéì Szettek Kezel√©se</h1>
        <a href="/admin-dashboard.html" class="back-btn">
            <i data-lucide="arrow-left"></i>
            Vissza
        </a>
    </div>

    <div class="main-content">
        <!-- Search and Filters -->
        <div class="search-filters">
            <div class="search-row">
                <input type="text" class="search-input" id="searchSet" placeholder="üîç Szett neve keres√©se...">
                <input type="text" class="search-input" id="searchClass" placeholder="üè´ Csoport keres√©se...">
                <input type="text" class="search-input" id="searchTeacher" placeholder="üë®‚Äçüè´ Tan√°r keres√©se...">
                <input type="text" class="search-input" id="searchStudent" placeholder="üë®‚Äçüéì Di√°k keres√©se...">
            </div>
        </div>

        <!-- Sets Table -->
        <div class="sets-table">
            <table>
                <thead>
                    <tr>
                        <th>Szett</th>
                        <th>Csoport</th>
                        <th>Tan√°r</th>
                        <th>Szint</th>
                        <th>Di√°kok</th>
                        <th>K√°rty√°k</th>
                        <th>Utols√≥ friss√≠t√©s</th>
                    </tr>
                </thead>
                <tbody id="setsTableBody">
                    <tr>
                        <td colspan="7" class="loading">
                            <i data-lucide="loader-2" style="animation: spin 1s linear infinite;"></i>
                            Szettek bet√∂lt√©se...
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="toast">
        <div id="toastMessage"></div>
    </div>

    <script>
        console.log('üéì CLEAN SETS MANAGEMENT LOADED');
        
        // Initialize Lucide icons
        lucide.createIcons();
        
        // Supabase setup
        const supabaseUrl = 'https://ycxqxdhaxehspypqbnpi.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InljeHF4ZGhheGVoc3B5cHFibnBpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMyMDMwMzEsImV4cCI6MjA2ODc3OTAzMX0.7RGVld6WOhNgeTA6xQc_U_eDXfMGzIshUlKV6j2Ru6g';
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);
        
        let currentUser = null;
        let currentSchool = null;
        let allSets = [];
        let filteredSets = [];
        
        async function checkAuth() {
            try {
                const { data: { user } } = await supabase.auth.getUser();
                if (!user) {
                    window.location.href = '/login.html';
                    return;
                }
                
                currentUser = user;
                
                // Get user profile with school info
                const { data: profile } = await supabase
                    .from('user_profiles')
                    .select(`*, schools(*)`)
                    .eq('id', user.id)
                    .single();
                
                if (profile?.schools) {
                    currentSchool = profile.schools;
                    await loadSets();
                } else {
                    showEmptyState('Nincs hozz√°rendelt iskola');
                }
                
            } catch (error) {
                console.error('‚ùå Auth error:', error);
                showToast('Hiba a bejelentkez√©skor', 'error');
            }
        }
        
        async function loadSets() {
            try {
                const tableBody = document.getElementById('setsTableBody');
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="7" class="loading">
                            <i data-lucide="loader-2" style="animation: spin 1s linear infinite;"></i>
                            Szettek bet√∂lt√©se...
                        </td>
                    </tr>
                `;
                
                // Load flashcard sets from Supabase
                const { data: sets, error } = await supabase
                    .from('flashcard_sets')
                    .select(`
                        *,
                        categories(name, color),
                        user_profiles!creator_id(first_name, last_name)
                    `)
                    .eq('is_mock', currentSchool.is_mock || false)
                    .order('created_at', { ascending: false });
                
                if (error) {
                    console.error('‚ùå Error loading sets:', error);
                    showEmptyState('Hiba a szettek bet√∂lt√©s√©n√©l');
                    return;
                }
                
                allSets = sets || [];
                filteredSets = [...allSets];
                renderSets();
                
                console.log('üìö Sets loaded:', allSets.length);
                
            } catch (error) {
                console.error('‚ùå Error loading sets:', error);
                showEmptyState('Hiba a szettek bet√∂lt√©s√©n√©l');
            }
        }
        
        function renderSets() {
            const tableBody = document.getElementById('setsTableBody');
            
            if (filteredSets.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="7" class="empty-state">
                            <h3>üìö Nincsenek szettek</h3>
                            <p>M√©g nem tal√°lhat√≥ egyetlen szett sem.</p>
                        </td>
                    </tr>
                `;
                return;
            }
            
            tableBody.innerHTML = filteredSets.map(set => `
                <tr>
                    <td>
                        <div class="set-name">${escapeHtml(set.title)}</div>
                        <div class="set-description">${escapeHtml(set.description || '')}</div>
                    </td>
                    <td>-</td>
                    <td>${escapeHtml(set.user_profiles?.first_name || 'Ismeretlen')} ${escapeHtml(set.user_profiles?.last_name || '')}</td>
                    <td>${renderCefrBadge(set.difficulty)}</td>
                    <td><span class="student-count">0</span></td>
                    <td>${set.card_count || 0}</td>
                    <td>${formatDate(set.created_at)}</td>
                </tr>
            `).join('');
        }
        
        function renderCefrBadge(difficulty) {
            if (!difficulty) return '';
            
            const level = difficulty.toUpperCase();
            const className = `cefr-${level.toLowerCase()}`;
            
            return `<span class="cefr-badge ${className}">${level}</span>`;
        }
        
        function formatDate(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            return date.toLocaleDateString('hu-HU');
        }
        
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        function showEmptyState(message) {
            const tableBody = document.getElementById('setsTableBody');
            tableBody.innerHTML = `
                <tr>
                    <td colspan="7" class="empty-state">
                        <h3>üì≠ ${escapeHtml(message)}</h3>
                    </td>
                </tr>
            `;
        }
        
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toastMessage');
            
            toastMessage.textContent = message;
            toast.className = `toast ${type}`;
            toast.style.display = 'block';
            
            setTimeout(() => {
                toast.style.display = 'none';
            }, 3000);
        }
        
        // Search functionality
        function setupSearch() {
            const searchInputs = ['searchSet', 'searchClass', 'searchTeacher', 'searchStudent'];
            
            searchInputs.forEach(inputId => {
                document.getElementById(inputId).addEventListener('input', filterSets);
            });
        }
        
        function filterSets() {
            const searchSet = document.getElementById('searchSet').value.toLowerCase();
            const searchClass = document.getElementById('searchClass').value.toLowerCase();
            const searchTeacher = document.getElementById('searchTeacher').value.toLowerCase();
            const searchStudent = document.getElementById('searchStudent').value.toLowerCase();
            
            filteredSets = allSets.filter(set => {
                const matchesSet = !searchSet || 
                    set.title.toLowerCase().includes(searchSet) || 
                    (set.description && set.description.toLowerCase().includes(searchSet));
                
                const matchesClass = !searchClass; // TODO: Implement when classrooms are connected
                
                const matchesTeacher = !searchTeacher || 
                    (set.user_profiles?.first_name && set.user_profiles.first_name.toLowerCase().includes(searchTeacher)) ||
                    (set.user_profiles?.last_name && set.user_profiles.last_name.toLowerCase().includes(searchTeacher));
                
                const matchesStudent = !searchStudent; // TODO: Implement when students are connected
                
                return matchesSet && matchesClass && matchesTeacher && matchesStudent;
            });
            
            renderSets();
        }
        
        // Initialize when DOM is loaded
        document.addEventListener('DOMContentLoaded', async function() {
            await checkAuth();
            setupSearch();
        });
        
    </script>

    <style>
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
    </style>

</body>
</html>
<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üè´ ISKOLA ADMIN DASHBOARD</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <style>
        body {
            font-family: Inter, sans-serif;
            background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 50%, #c7d2fe 100%);
            margin: 0;
            padding: 20px;
        }
        .header {
            background: rgba(255,255,255,0.8);
            backdrop-filter: blur(12px);
            border-radius: 24px;
            padding: 20px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
            z-index: 1000;
        }
        .school-info h1 {
            margin: 0;
            color: #7c3aed;
            font-size: 1.8rem;
        }
        .school-info p {
            margin: 0;
            color: #64748b;
        }
        .user-info {
            display: flex;
            align-items: center;
            gap: 12px;
            position: relative;
        }
        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            cursor: pointer;
        }
        .user-menu {
            position: absolute;
            top: 50px;
            right: 0;
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            display: none;
            min-width: 200px;
            z-index: 2000;
        }
        .user-menu button {
            width: 100%;
            padding: 12px 16px;
            border: none;
            background: none;
            text-align: left;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .user-menu button:hover {
            background: #f1f5f9;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-bottom: 20px;
        }
        .stat-card {
            background: rgba(255,255,255,0.8);
            backdrop-filter: blur(12px);
            border-radius: 16px;
            padding: 20px;
            text-align: center;
        }
        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: #7c3aed;
        }
        .actions {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
        }
        .action-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 16px;
            padding: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 600;
        }
        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 32px rgba(102, 126, 234, 0.6);
        }
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            border-radius: 12px;
            padding: 16px 20px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            z-index: 10000;
            display: none;
        }
        .toast.success {
            border-left: 4px solid #10b981;
        }
        .toast.error {
            border-left: 4px solid #ef4444;
        }
        @media (max-width: 768px) {
            .stats { grid-template-columns: repeat(2, 1fr); }
            .actions { grid-template-columns: repeat(2, 1fr); }
        }
        @media (max-width: 480px) {
            .stats { grid-template-columns: 1fr; }
            .actions { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="school-info">
            <h1 class="school-name">Iskola Bet√∂lt√©se...</h1>
            <p>Iskola Admin Dashboard</p>
        </div>
        <div class="user-info">
            <span id="userName">Admin</span>
            <div class="user-avatar" id="userAvatar" onclick="toggleUserMenu()">A</div>
            <div class="user-menu" id="userMenu">
                <button onclick="openSchoolSettings()">
                    <i data-lucide="settings"></i>
                    Iskola Be√°ll√≠t√°sok
                </button>
                <button onclick="logout()">
                    <i data-lucide="log-out"></i>
                    Kijelentkez√©s
                </button>
            </div>
        </div>
    </div>

    <!-- Statistics -->
    <div class="stats">
        <div class="stat-card">
            <div class="stat-number" id="teachersCount">0</div>
            <div>Tan√°rok</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="classroomsCount">0</div>
            <div>Csoportok</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="studentsCount">0</div>
            <div>Di√°kok</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="setsCount">0</div>
            <div>Szettek</div>
        </div>
    </div>

    <!-- Quick Actions -->
    <h2 style="color: #1e293b;">‚ö° Gyors M≈±veletek</h2>
    <div class="actions">
        <button class="action-btn" onclick="manageTeachers()">
            <i data-lucide="users"></i>
            Tan√°rok
        </button>
        <button class="action-btn" onclick="manageClassrooms()">
            <i data-lucide="school"></i>
            Csoportok
        </button>
        <button class="action-btn" onclick="window.location.href='/admin/sets-management.html'">
            <i data-lucide="layers"></i>
            Szettek
        </button>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="toast">
        <div id="toastMessage"></div>
    </div>

    <script>
        console.log('üè´ CLEAN ADMIN DASHBOARD LOADED');
        
        // Initialize Lucide icons
        lucide.createIcons();
        
        // Supabase setup
        const supabaseUrl = 'https://ycxqxdhaxehspypqbnpi.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InljeHF4ZGhheGVoc3B5cHFibnBpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMyMDMwMzEsImV4cCI6MjA2ODc3OTAzMX0.7RGVld6WOhNgeTA6xQc_U_eDXfMGzIshUlKV6j2Ru6g';
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);
        
        let currentUser = null;
        let currentSchool = null;
        
        async function checkAuth() {
            try {
                const { data: { user } } = await supabase.auth.getUser();
                if (!user) {
                    window.location.href = '/login.html';
                    return;
                }
                
                currentUser = user;
                console.log('‚úÖ User logged in:', user.email);
                
                // Get user profile with school info
                const { data: profile } = await supabase
                    .from('user_profiles')
                    .select(`*, schools(*)`)
                    .eq('id', user.id)
                    .single();
                
                if (profile?.schools) {
                    currentSchool = profile.schools;
                    document.querySelector('.school-name').textContent = currentSchool.name;
                    console.log('üè´ School:', currentSchool.name);
                    await loadDashboardData();
                } else {
                    document.querySelector('.school-name').textContent = '√öj Iskola L√©trehoz√°sa';
                    console.log('üìù No school assigned - showing empty dashboard');
                    showEmptyDashboard();
                }
                
                const firstName = user.user_metadata?.first_name || 'Admin';
                document.getElementById('userName').textContent = firstName;
                document.getElementById('userAvatar').textContent = firstName.charAt(0).toUpperCase();
                
            } catch (error) {
                console.error('‚ùå Auth error:', error);
                showToast('Hiba a bejelentkez√©skor', 'error');
            }
        }
        
        async function loadDashboardData() {
            if (!currentSchool) {
                showEmptyDashboard();
                return;
            }
            
            try {
                // Load teachers count
                const { count: teachersCount } = await supabase
                    .from('user_profiles')
                    .select('*', { count: 'exact', head: true })
                    .eq('school_id', currentSchool.id)
                    .eq('user_role', 'teacher')
                    .eq('is_mock', currentSchool.is_mock || false);
                
                // Load classrooms count  
                const { count: classroomsCount } = await supabase
                    .from('classrooms')
                    .select('*', { count: 'exact', head: true })
                    .eq('school_id', currentSchool.id)
                    .eq('is_mock', currentSchool.is_mock || false);
                
                // Load sets count (via classroom assignments)
                const { count: setsCount } = await supabase
                    .from('flashcard_sets')
                    .select('*', { count: 'exact', head: true })
                    .eq('is_mock', currentSchool.is_mock || false);
                
                // Update statistics
                document.getElementById('teachersCount').textContent = teachersCount || 0;
                document.getElementById('classroomsCount').textContent = classroomsCount || 0;
                document.getElementById('studentsCount').textContent = '0'; // TODO: Calculate students
                document.getElementById('setsCount').textContent = setsCount || 0;
                
                console.log('üìä Statistics loaded:', { teachersCount, classroomsCount, setsCount });
                
            } catch (error) {
                console.error('‚ùå Error loading dashboard data:', error);
                showEmptyDashboard();
            }
        }
        
        function showEmptyDashboard() {
            document.getElementById('teachersCount').textContent = '0';
            document.getElementById('classroomsCount').textContent = '0';
            document.getElementById('studentsCount').textContent = '0';
            document.getElementById('setsCount').textContent = '0';
        }
        
        function toggleUserMenu() {
            const menu = document.getElementById('userMenu');
            menu.style.display = menu.style.display === 'none' || menu.style.display === '' ? 'block' : 'none';
        }
        
        function openSchoolSettings() {
            showToast('Iskola be√°ll√≠t√°sok funkci√≥ fejleszt√©s alatt...', 'error');
            toggleUserMenu();
        }
        
        function manageTeachers() {
            showToast('Tan√°rok kezel√©se funkci√≥ fejleszt√©s alatt...', 'error');
        }
        
        function manageClassrooms() {
            showToast('Csoportok kezel√©se funkci√≥ fejleszt√©s alatt...', 'error');
        }
        
        async function logout() {
            const { error } = await supabase.auth.signOut();
            if (error) {
                console.error('Logout error:', error);
            } else {
                window.location.href = '/login.html';
            }
        }
        
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toastMessage');
            
            toastMessage.textContent = message;
            toast.className = `toast ${type}`;
            toast.style.display = 'block';
            
            setTimeout(() => {
                toast.style.display = 'none';
            }, 3000);
        }
        
        // Close menu when clicking outside
        document.addEventListener('click', function(event) {
            const menu = document.getElementById('userMenu');
            const avatar = document.getElementById('userAvatar');
            
            if (!avatar.contains(event.target) && !menu.contains(event.target)) {
                menu.style.display = 'none';
            }
        });
        
        // Initialize dashboard when DOM is loaded
        document.addEventListener('DOMContentLoaded', async function() {
            await checkAuth();
        });
        
    </script>

</body>
</html>